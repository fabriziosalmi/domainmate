name: ğŸ“Š Daily Audit & Pages

on:
  schedule:
    - cron: '0 8 * * *' # Daily at 08:00 UTC
  workflow_dispatch: # Manual trigger

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  audit-and-publish:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: ğŸ¤« Inject Secret Config (Optional)
        if: "${{ secrets.DOMAINMATE_CONFIG_CONTENT != '' }}"
        run: echo "${{ secrets.DOMAINMATE_CONFIG_CONTENT }}" > config.yaml

      - name: ğŸ” Run DomainMate Audit
        env:
          # Inject secrets if configured in Repo Settings
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          python src/cli.py --notify

      - name: ğŸ› ï¸ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'reports'

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
